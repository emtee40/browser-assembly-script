<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM x86 Assembly Interpreter</title>
</head>

<body>
    <script>
        var inputText = `#
# Generated by the MemeAssembly compiler v1.5 on Wed Jun 22 07:05:25 2022
#
.intel_syntax noprefix
.global main

.data
	.LCharacter: .ascii "a"
	.Ltmp64: .byte 0, 0, 0, 0, 0, 0, 0, 0
	.LsigStruct:
		.Lsa_handler: .quad 0
		.quad 0x04000000
		.quad 0, 0



.text


.Ltext0:
killParent:
    mov rax, 110
    syscall

    mov rdi, rax
    mov rsi, 9
    mov rax, 62
    syscall

    mov rdi, 0
    mov rax, 60
    syscall
    ret

main:
	.LConfusedStonks_0:
	mov eax, 65
	xor rax, rax
	ret


writechar:
	push rcx
	push r11
	push rax
	push rdi
	push rsi
	push rdx
	mov rdx, 1
	lea rsi, [rip + .LCharacter]
	mov rax, 1
	syscall
	pop rdx
	pop rsi
	pop rdi
	pop rax
	pop r11
	pop rcx

	ret


readchar:
	push rcx
	push r11
	push rax
	push rdi
	push rsi
	push rdx

	mov rdx, 1
	lea rsi, [rip + .LCharacter]
	mov rdi, 0
	mov rax, 0
	syscall

	pop rdx
	pop rsi
	pop rdi
	pop rax
	pop r11
	pop rcx
	ret
`
    </script>

    <script type="module">
        import * as mod from "./pkg/assembly_script.js";

        console.log(mod.interpret_assembly_file);

        console.log("Waiting for download to complete...");
        await mod.default();
        console.log("Download done!");


        async function runGNULikeAssembler() {
            console.log("running");
            let result = mod.assemble(inputText, 0x2000n, 0x1000n, "main");
            console.log(result);
        }

		function appendText(str) {
			console.log("log:", str)
		}

        async function runWrap() {
            try {
                await runGNULikeAssembler();
            } catch (e) {
                appendText(String(e));
                if (typeof e === "object")
                    appendText(JSON.stringify(e, null, "    "))
            }
        }

        runWrap();
    </script>
</body>

</html>
